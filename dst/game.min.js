var t,e=!1,i=!1,h={songData:[{i:[3,162,128,0,3,0,128,0,0,0,5,6,45,0,0,0,0,6,1,2,255,0,6,69,0,6,0,6],p:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,27,33,27,33,27,33,27,33],c:[{n:[113,,113,113,113,,113,113,,108,113,108,115,116,111,108,,113,113,,113,,113,113,,108,113,108,115,116,111,115],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[121,,121,121,121,,121,121,,116,121,116,123,125,116,121,,120,120,,120,,120,120,,111,115,111,118,120,123,125],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[118,,118,118,118,,118,118,,113,118,113,120,121,123,115,,115,115,,115,,115,115,,113,111,113,115,116,118,120],f:[]}]},{i:[0,119,128,1,3,0,128,0,0,0,0,0,43,0,0,0,0,6,1,2,255,117,3,212,0,6,0,6],p:[,,,,2,2,2,,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],c:[{n:[],f:[]},{n:[125,,,125,,,125,125,,,125,,,,,,,,125,125,,,,125,,,125],f:[]}]},{i:[2,0,128,0,3,0,128,0,0,196,5,6,41,0,0,0,0,6,1,2,149,0,0,116,0,6,27,6],p:[,,,7,3,3,3,7,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],c:[{n:[],f:[]},{n:[],f:[]},{n:[,,,,137,,,,,,,,137,,,,,,,,137,,,,,,,,137,,137,137],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,137,,137,137],f:[]}]},{i:[2,0,128,0,3,0,128,0,0,131,5,6,29,0,0,0,0,6,1,1,135,0,0,32,147,6,92,2],p:[,,4,8,4,4,4,8,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[185,,,185,,,185,,,185,,,185,185,,,185,,,185,,,185,,,185,,,185,185],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[185,,,185,,,185,,,185,,,185,185],f:[]}]},{i:[2,100,128,0,1,201,128,0,0,0,5,6,44,0,0,0,0,6,1,2,83,0,0,5,147,6,45,6],p:[,,,,5,5,5,5,5,5,5,5,5,5,5,5,11,29,11,29,11,29,11,29],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[137,137,137,,137,137,,137,,137,137,,137,137,,137,,125,125,,137,137,,137,,137,137,,137,137,,137,140,140,140,,140,140,,140,,140,140,,140,140,,140,,128,128,,140,140,,140,,140,140,,140,140,,140,144,144,144,,144,144,,144,,144,144,,144,144,,144,,132,132,,144,144,,144,,144,144,,144,144,,144,147,147,147,,147,147,,147,,147,147,,147,147,,147,,135,135,,147,147,,147,,147,147,,147,147,,147],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[137,137,137,,137,137,,137,,137,137,,137,137,,137,,123,123,,135,135,,135,,135,135,,135,135,,135,140,140,140,,140,140,,140,,140,140,,140,140,,140,,127,127,,139,139,,139,,139,139,,139,139,,139,144,144,144,,144,144,,144,,144,144,,144,144,,144,,130,130,,142,142,,142,,142,142,,142,142,,142,147,147,147,,147,147,,147,,147,147,,147,147,,147,,132,132,,144,144,,144,,144,144,,144,144,,144],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[137,137,137,,137,137,,137,,137,137,,137,137,,137,,123,123,,135,135,,135,,135,135,,135,135,,135,140,140,140,,140,140,,140,,140,140,,140,140,,140,,127,127,,139,139,,139,,139,139,,139,139,,139,142,142,142,,142,142,,142,,142,142,,142,142,,142,,130,130,,142,142,,142,,142,142,,142,142,,142,145,145,145,,145,145,,145,,145,145,,145,145,,145,,133,133,,145,145,,145,,145,145,,145,145,,145],f:[]}]},{i:[1,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,6,1,2,188,53,0,32,0,6,27,6],p:[,,,,,,,,6,9,6,10,6,9,6,10,36,34,13,32,36,34,13,32],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,152,,,,151,,147,,,,154,,,,152,,,,151,,,,147,,144,,142],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,152,,,,151,,147,,,,154,,,,156,,,,144,,154,,152,,151,,152],f:[]},{n:[,,,,152,,,,151,,147,,,,140,,151,,152,,142,,154,,156,,144,,159,,161],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,149,,,,152,,,,157,,,,159,,,,161,,159,,,,152,,163,,164],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,166,,164,,163,,159,,,,,,164,,163,,159,,156,,,,154,156,157,159,161,156,152,151],f:[]},{n:[],f:[]},{n:[,,157,,156,,152,,149,,,,147,,149,,151,,152,,151,,147,,142,140,139,140,142,144,145,147],f:[]},{n:[],f:[]},{n:[,,,,149,,,,152,,,,157,,,,159,,,,161,,159,,,,152,,156,,157],f:[]}]}],rowLen:5088,patternLen:32,endPattern:23,numChannels:6},n=function(){var t,e,s,i,h,n=function(t){return Math.sin(6.283184*t)},a=function(t){return.003959503758*Math.pow(2,(t-128)/12)},o=function(t,e,s){var i,h,n,o,c,l,f,d=r[t.i[0]],u=t.i[1],x=t.i[3],y=r[t.i[4]],p=t.i[5],m=t.i[8],w=t.i[9],g=t.i[10]*t.i[10]*4,k=t.i[11]*t.i[11]*4,E=t.i[12]*t.i[12]*4,v=1/E,M=t.i[13],H=s*Math.pow(2,2-t.i[14]),b=new Int32Array(g+k+E),I=0,S=0;for(i=0,h=0;i<g+k+E;i++,h++)h>=0&&(h-=H,l=a(e+(15&(M=M>>8|(255&M)<<4))+t.i[2]-128),f=a(e+(15&M)+t.i[6]-128)*(1+8e-4*t.i[7])),n=1,i<g?n=i/g:i>=g+k&&(n-=(i-g-k)*v),o=l,x&&(o*=n*n),c=d(I+=o)*u,o=f,m&&(o*=n*n),c+=y(S+=o)*p,w&&(c+=(2*Math.random()-1)*w),b[i]=80*c*n|0;return b},r=[n,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var e=t%1*4;return e<2?e-1:3-e}];this.init=function(n){t=n,e=n.endPattern,s=0,i=n.rowLen*n.patternLen*(e+1)*2,h=new Int32Array(i)},this.generate=function(){var a,c,l,f,d,u,x,y,p,m,w,g,k,E,v=new Int32Array(i),M=t.songData[s],H=t.rowLen,b=t.patternLen,I=0,S=0,A=!1,L=[];for(l=0;l<=e;++l)for(x=M.p[l],f=0;f<b;++f){var R=x?M.c[x-1].f[f]:0;R&&(M.i[R-1]=M.c[x-1].f[f+b]||0,R<16&&(L=[]));var C=r[M.i[15]],T=M.i[16]/512,W=Math.pow(2,M.i[17]-9)/H,P=M.i[18],D=M.i[19],O=43.23529*M.i[20]*3.141592/44100,B=1-M.i[21]/255,F=1e-5*M.i[22],U=M.i[23]/32,G=M.i[24]/512,Y=6.283184*Math.pow(2,M.i[25]-9)/H,z=M.i[26]/255,N=M.i[27]*H&-2;for(w=(l*b+f)*H,d=0;d<4;++d)if(u=x?M.c[x-1].n[f+d*b]:0){L[u]||(L[u]=o(M,u,H));var K=L[u];for(c=0,a=2*w;c<K.length;c++,a+=2)v[a]+=K[c]}for(c=0;c<H;c++)(m=v[y=2*(w+c)])||A?(g=O,P&&(g*=C(W*y)*T+.5),S+=(g=1.5*Math.sin(g))*(k=B*(m-S)-(I+=g*S)),m=3==D?S:1==D?k:I,F&&(m=(m*=F)<1?m>-1?n(.25*m):-1:1,m/=F),A=(m*=U)*m>1e-5,E=m*(1-(p=Math.sin(Y*y)*G+.5)),m*=p):E=0,y>=N&&(E+=v[y-N+1]*z,m+=v[y-N]*z),v[y]=0|E,v[y+1]=0|m,h[y]+=0|E,h[y+1]+=0|m}return++s/t.numChannels},this.createWave=function(){var t=44+2*i-8,e=t-36,s=new Uint8Array(44+2*i);s.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var n=0,a=44;n<i;++n){var o=h[n];o=o<-32767?-32767:o>32767?32767:o,s[a++]=255&o,s[a++]=o>>8&255}return s},this.getData=function(t,e){for(var s=2*Math.floor(44100*t),i=new Array(e),n=0;n<2*e;n+=1){var a=s+n;i[n]=t>0&&a<h.length?h[a]/32768:0}return i}};function a(){var s=new n;s.init(h),setInterval(function(){if(!e&&(e=s.generate()>=1)){var h=s.createWave();(t=document.createElement("audio")).src=URL.createObjectURL(new Blob([h],{type:"audio/wav"})),i=!0}},0)}function o(t,e,s,i,h,n,a,o=y){this.time=0,this.x=s,this.y=i,this.w=t,this.h=e,this.type=n,this.endPos=at(this),this.speed=5,this.angle=Math.atan2(this.endPos.y-this.y,this.endPos.x-this.x),this.remove=!1,this.alpha=1,this.colour="#"+["FF0000","B30000","7D0000","FF8080"][G(0,3)],this.no=1,"dust"==this.type&&(this.colour="#"+["4d1933","EDEDED"][G(0,1)],this.alpha=.1),this.rndCol=a,this.lastDir=o,this.update=function(t,e){if(this.time+=e,t.save(),t.translate(Lt.cam.x,Lt.cam.y),"circle"==this.type){let e=Math.atan2(this.y-this.endPos.y,this.x-this.endPos.x)+Math.PI+2*(Math.random()-.5);Math.hypot(this.endPos.x-this.x,this.endPos.y-this.y)>=10&&(this.x+=Math.cos(e)*this.speed-this.time,this.y+=Math.sin(e)*this.speed-this.time),this.alpha-=.01,this.w>1&&(this.w-=.75),t.beginPath(),t.globalAlpha=this.alpha,t.arc(this.x,this.y,this.w,0,6.283185307179586);let s=this.rndCol?ot():this.colour;t.fillStyle=s,t.fill(),this.time>.6&&(this.remove=!0)}else"dust"==this.type&&(this.lastDir==y?this.x-=2:this.x+=2,this.y-=G(1,5)/10,t.beginPath(),t.globalAlpha=this.alpha,t.arc(this.x,this.y,this.w,0,6.283185307179586),t.fillStyle=this.colour,t.fill(),this.alpha>.1&&(this.alpha-=.01),this.w+=.1,this.time>.5&&(this.remove=!0));t.globalAlpha=1,t.restore()}}function l(){this.decors=[];var t=20;for(let e=0;e<t;e++){let t=2e3*Math.random()-1e3,e=2e3*Math.random()-1e3;this.decors.push(new P(9,6,t,e,0,O.SMALLROCK))}numRocks=15;for(let e=0;e<t;e++){let t=2e3*Math.random()-1e3,e=2e3*Math.random()-1e3;this.decors.push(new P(14,10,t,e,0,O.BIGROCK))}t=15;for(let e=0;e<t;e++){let t=2e3*Math.random()-1e3,e=2e3*Math.random()-1e3;this.decors.push(new P(14,14,t,e,0,O.STUMP))}t=10;for(let e=0;e<t;e++){let t=2e3*Math.random()-1e3,e=2e3*Math.random()-1e3;this.decors.push(new P(10,9,t,e,0,O.BIGMUSH))}t=25;for(let e=0;e<t;e++){let t=2e3*Math.random()-1e3,e=2e3*Math.random()-1e3;this.decors.push(new P(7,7,t,e,0,O.SMALLMUSH))}this.update=function(t,e){this.decors.forEach(e=>{e.update(t)})}}function f(t){this.hero=t,this.enemies=[],this.update=function(t,e){this.enemies.forEach(e=>{e.update(t,this.enemies),e.e.update(t)}),this.enemies=this.enemies.filter(function(t){return t.active})},this.addEnemy=function(t,e){for(let s=0;s<t;s++){let i=s/t*2*Math.PI,h=new d(0,0,9,8,[O.LILY,O.LILG,O.LILP][G(0,2)],s,t);h.e.x=this.hero.x+e*Math.cos(i),h.e.y=this.hero.y+e*Math.sin(i),this.enemies.push(h)}},this.addEnemy(200,600)}function d(t,e,s,i,h,n,a){this.active=!0,this.e=new P(s,i,0,0,0,h),this.speed=.8,this.angleOffset=2*Math.PI*(n/a),this.safe=0,this.update=function(t,e){this.safe>0&&(this.safe-=t);let s=this.steerFromNearbyMobs(e,60),i=Lt.hero.e.x+10*Math.cos(this.angleOffset),h=Lt.hero.e.y+10*Math.sin(this.angleOffset);this.e.x+=(i-this.e.x>0?this.speed:-this.speed)+s.x,this.e.y+=(h-this.e.y>0?this.speed:-this.speed)+s.y,this.e.isCollidingWith(Lt.hero.e)&&this.safe<=0&&(Lt.hero.hp>0&&Lt.hero.hp--,Lt.shakeTime=.2,tt(Lt.hero,this,5),this.safe=2),Lt.attacks.weapons.forEach(t=>{if(t.attack&&this.e.isCollidingWith(t)){this.active=!1,Lt.hero.power<100&&Lt.hero.power++,Lt.shakeTime=.2;for(let t=0;t<30;t++)Lt.hero.particles.push(new o(G(3,15),G(3,15),this.e.x+5,this.e.y+5,0,"circle",!0,y))}})},this.steerFromNearbyMobs=function(t,e){let s=0,i=0,h=0;for(let n=0;n<t.length;n++){let a=t[n],o=Math.sqrt(Math.pow(this.e.x-a.e.x,2)+Math.pow(this.e.y-a.e.y,2));a!==this&&o<e&&(s+=this.e.x-a.e.x,i+=this.e.y-a.e.y,h++)}h>0&&(s/=h,i/=h);let n=Math.sqrt(s*s+i*i);return n>0&&(s/=n,i/=n),{x:s,y:i}}}function u(t=0,e=0){this.x=t,this.y=e}var x=37,y=39,p=38,m=40,w=16,g=87,k=65,E=83,v=68,M=77,H=0,b=2,I=32,S=69,A=49,L=50,R=51,C=52,T=82,W=84;function P(t,e,i,h,n,a,o=0){this.type=a,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScld=t/-2,this.mhHScld=e/-2,this.hWidth=t/2,this.hHeight=e/2,this.cenX=i-this.mhWScld,this.cenY=h-this.mhHScld,this.angle=n,this.x=i,this.y=h,this.image=St,this.alpha=1,this.isSolid=!1,this.flip=!1,this.dir=0,this.id=o,this.open=!1,this.chasePhase="search",this.content="",this.attack=!1,this.sx=0,this.sy=0,this.move=function(){ne()&&(this.x-=5,this.dir=1),ae()&&(this.x+=5,this.dir=0),oe()&&(this.y-=5),re()&&(this.y+=5);this.x<-1e3&&(this.x=-1e3),this.x>1e3&&(this.x=1e3),this.y<-1e3&&(this.y=-1e3),this.y>1e3&&(this.y=1e3)},this.update=function(i){this.x=Math.floor(this.x),this.Y=Math.floor(this.Y),ctx.save(),ctx.translate(this.x,this.y),Lt.shakeTime>0&&ctx.translate(Lt.shake,Lt.shake),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,ctx.translate(Lt.cam.x,Lt.cam.y),this.flip?(this.type==O.HAIR2?ctx.translate(8.3*t,0):ctx.translate(-7*-t,0),ctx.scale(-Ot,Ot)):ctx.scale(Ot,Ot),ctx.drawImage(img,this.sx,this.sy,t,e,hw,hh,t,e),ctx.restore(),this.cenX=this.x-this.mhWScld,this.cenY=this.y-this.mhHScld},this.isCollidingWith=function(t){return!(this.x+this.width<t.x-t.width||this.x-this.width>t.x+t.width||this.y+this.height<t.y-t.height||this.y-this.height>t.y+t.height)},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.type){case O.HERO:break;case O.ENEMY:case O.GRASS:this.sx=16;break;case O.SHIELD:this.sx=29;break;case O.HAIR1:this.sx=63,this.width=13,this.height=13;break;case O.HAIR2:this.sx=77,this.width=15,this.height=12;break;case O.HAIR3:this.sx=94,this.width=13,this.height=11;break;case O.HAIR4:this.sx=50,this.sy=12,this.width=11,this.height=8;break;case O.HEAD1:this.sx=2,this.sy=1;break;case O.HEAD2:this.sx=48,this.sy=1;break;case O.HEAD3:this.sx=11,this.sy=17;break;case O.HAT:this.sx=91,this.sy=13;break;case O.HAND:this.sx=30,this.sy=9;break;case O.ARROW:this.sx=36,this.sy=3;break;case O.SMALLROCK:this.sx=24,this.sy=17;break;case O.BIGROCK:this.sx=35,this.sy=16;break;case O.STUMP:this.sx=23,this.sy=25;break;case O.SMALLMUSH:this.sy=32;break;case O.BIGMUSH:this.sy=20;break;case O.LILY:this.sy=40,this.sx=53;break;case O.LILG:this.sy=40,this.sx=63;break;case O.LILP:this.sy=40,this.sx=73;break;case O.CHEST:this.sy=23,this.sx=67;break;case O.ONE:this.sx=63,this.sy=15;break;case O.TWO:this.sx=75,this.sy=15;break;case O.THREE:this.sx=85,this.sy=29;break;case O.C1:this.sy=40;break;case O.C2:this.sy=40,this.sx=8;break;case O.C3:this.sy=40,this.sx=16;break;case O.C4:this.sy=40,this.sx=24;break;case O.C5:this.sy=40,this.sx=32;break;case O.SHADOW:this.sy=43,this.sx=94;break;case O.HAT:this.sy=13,this.sx=91}this.hWidth=this.width/2,this.hHeight=this.height/2},this.setType()}function D(t,e,s,i,h,n){this.e=new P(16,16,0,0,0,O.HERO),this.hair=new P(13,13,0,0,0,O.HAIR1),this.head=new P(11,9,0,0,0,O.HEAD1),this.hat=new P(16,14,0,0,0,O.HAT),this.rHand=new P(4,4,0,0,0,O.HAND),this.lHand=new P(4,4,0,0,0,O.HAND),this.change=!1,this.handMovementPhase=0,this.hp=100,this.power=0,this.particles=[],this.showhat=!1,this.maxHP=100,this.update=function(t){switch(this.e.move(t),this.e.update(t),this.particles.forEach(e=>{e.update(ctx,t)}),this.particles=this.particles.filter(function(t){return 0==t.remove}),ut&&(Lt.hero.e.flip=1==this.e.dir,Lt.hero.hair.flip=1==this.e.dir,Lt.hero.head.flip=1==this.e.dir),this.head.x=this.e.x+18,this.head.y=this.e.y+18,this.head.update(t),this.hair.type){case O.HAIR1:this.hair.x=this.e.x+8,this.hair.y=this.e.y-6;break;case O.HAIR2:this.hair.x=this.e.x-6,this.hair.y=this.e.y-8;break;case O.HAIR3:this.hair.x=this.e.x+10,this.hair.y=this.e.y+2;break;case O.HAIR4:case O.HAT:this.hair.x=this.e.x+18,this.hair.y=this.e.y+20}this.change&&(this.hairChange=!1,this.head.setType(),this.hair.setType()),this.showhat||this.hair.update(t),this.handMovementPhase+=t;let e=3*Math.sin(2*this.handMovementPhase*Math.PI*.4),s=this.e.flip?55:65,i=this.e.flip?15:25;this.rHand.x=this.e.x+s,this.rHand.y=this.e.y+65+e,this.lHand.x=this.e.x+i,this.lHand.y=this.e.y+65+e,this.rHand.update(t),this.lHand.update(t),this.showhat&&(this.hat.flip=this.e.flip,this.hat.x=this.e.x+1,this.hat.y=this.e.y-8,this.hat.update(t))}}const O={AIR:0,GRASS:1,HERO:2,ENEMY:3,SHIELD:4,HAIR1:5,HAIR2:6,HAIR3:7,HAIR4:8,HAND:9,HEAD1:10,HEAD2:11,HEAD3:12,ARROW:13,SMALLROCK:14,BIGROCK:15,STUMP:16,BIGMUSH:17,SMALLMUSH:18,LILY:19,LILG:20,LILP:21,CHEST:22,ONE:23,TWO:24,THREE:25,C1:26,C2:27,C3:28,C4:29,C5:30,SHADOW:31,HAT:32};function B(t,e,s){angle=2*Math.PI*(e/s),e>=s&&(angle=2*Math.PI),t.beginPath(),t.fillStyle=1==qt?"#a6f1c8":"#ffb3a6",t.moveTo(400,35),t.arc(400,35,30,0,2*Math.PI),t.closePath(),t.fill(),t.beginPath(),t.fillStyle="white",t.moveTo(400,35),t.arc(400,35,30,-Math.PI/2,angle-Math.PI/2,!1),t.closePath(),t.fill(),t.beginPath(),t.moveTo(400,35),t.lineTo(400+30*Math.cos(angle-Math.PI/2),35+30*Math.sin(angle-Math.PI/2)),t.strokeStyle=1==qt?"#589572":"#f8847c",t.lineWidth=3,t.stroke()}function F(t,e,s,i,h,n,a){t.save(),t.translate(0,a);t.fillStyle=h,t.fillRect(10,10,200,20);const o=200*(e/s);t.fillStyle=n,t.fillRect(12,12,196,16),t.fillStyle=i,t.fillRect(12,12,o-4,16),t.font="14px Arial",t.fillStyle="black",t.textAlign="center",t.textBaseline="middle";t.fillText(`${e} / ${s}`,110,20),t.restore()}function U(t,e,s,i){this.x=t,this.y=e,this.w=s,this.h=i}function G(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function Y(t){return new U(t.x,t.y,t.w,t.h)}function z(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function N(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function K(t,e,s,i,h,n,a,o,r){t.save(),t.globalAlpha=r,t.translate(e,s),t.fillStyle=o,t.fillRect(i,h,n,a),t.restore()}function q(t,e,s){return(1-s)*t+s*e}function X(t,e){return cenX=Math.floor(t/2),cenY=Math.floor(e/2),{x:16*(cenX-cenY)/2,y:16*(cenX+cenY)/2}}function $(t){const e=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0);return Math.round(e*t)}function J(t,e,s,i,h,n,a){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=e,t.fillStyle=s,t.fillRect(i,h,n,a),t.restore()}function j(t,e,s,i,h,n,a){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=e,t.font=s,t.fillStyle=i,t.fillText(h,n,a),t.restore()}function Q(t,e,s,i,h){t.font=s;let n=i-t.measureText(e).width/2;V(t,1,s,"BLACK",e,n,h,12),j(t,1,s,"WHITE",e,n,h)}function V(t,e,s,i,h,n,a,o){t.save(),t.setTransform(1,0,0,1,0,0),t.globalAlpha=e,t.font=s,t.fillStyle=i,t.strokeStyle=i,t.lineWidth=o,t.strokeText(h,n,a),t.restore()}function Z(t,e,s,i){let h=t/32,n=(e+2*s+i)/32*2,a=n-h,o=h+n;return r=Math.floor(a),c=Math.floor(o),_(r,c)}function _(t,e){return Lt.level.tiles[e+Lt.levels[Lt.hero.e.curLevel].cols*t]}function tt(t,e,s){let i=t.e.x>e.x?1:-1,h=t.e.y>e.y?1:-1;t.e.x+=i*s,t.e.y+=h*s}const et={0:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],1:[[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],2:[[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],3:[[1,1,1,1,1],[0,0,0,0,1],[0,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1]],4:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1]],6:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1]],7:[[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[0,1,0,0,0]],8:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1]],9:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1]]};function st(t,e,s,i){for(let h=0;h<et[s].length;h++)for(let n=0;n<et[s][h].length;n++)1===et[s][h][n]&&(ctx.fillStyle="white",ctx.fillRect(t+n*i,e+h*i,i,i))}function it(t){Vt.context.fillStyle="yellow",Vt.context.font="16px Arial",Vt.context.fillText("FPS: "+t.toFixed(2),Gt-100,20)}function ht(t){Vt.context.fillStyle="white",Vt.context.font="16px Arial",Vt.context.fillText("Mobs: "+t,Gt-100,50)}function nt(t,e,s,i,h,n){ctx.save(),ctx.scale(3,3),ctx.shadowColor=1==n?"#3CB371":"#f67c84",ctx.shadowBlur=10,ctx.shadowOffsetX=5,ctx.shadowOffsetY=5,ctx.fillStyle="white",ctx.fill(),ctx.strokeStyle=1==n?"#3CB371":"#ffb3a6",ctx.lineWidth=4,ctx.stroke(),ctx.beginPath(),ctx.roundRect(50,45,150,90,40),ctx.stroke(),ctx.fill(),ctx.restore()}function at(t){var e=G(0,360)*Math.PI/180,s=G(50,180),i=[-1,1][G(0,1)]*s;return{x:t.x+i*Math.cos(e),y:t.y+i*Math.sin(e)}}function ot(){let t="#";for(var e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}function rt(t){this.hero=t,this.weapons=[],this.spinWeapons=[],this.chaseWeapons=[],[O.C1,O.C2,O.C3,O.C4].forEach(t=>{let e=new P(7,8,0,0,0,t);e.attack=!1,this.chaseWeapons.push(e),this.weapons.push(e)}),this.chasingTargets=new Set,this.figureEightEntity=new P(7,8,0,0,0,O.C5),this.figureEightEntity.attack=!1,this.weapons.push(this.figureEightEntity),this.numberOfRotatingItems=5,this.distanceFromHero=80;for(let t=0;t<this.numberOfRotatingItems;t++){const e=2*Math.PI/this.numberOfRotatingItems*t;let s=new P(6,8,this.hero.e.x+32+this.distanceFromHero*Math.cos(e),this.hero.e.y+32+this.distanceFromHero*Math.sin(e),0,O.SHIELD);this.weapons.push(s),this.spinWeapons.push(s)}this.spinWeapons[0].attack=!0,this.rotate=!0,this.spin=!1,this.chase=!0,this.loop=!0,this.applySeparation=function(t,e){let s=0,i=0;this.chaseWeapons.forEach(e=>{if(e.attack&&e!==t){let h=t.x-e.x,n=t.y-e.y,a=Math.sqrt(h*h+n*n);if(a>0&&a<30){let t=(30-a)/a;s+=h*t,i+=n*t}}}),t.x+=s*e,t.y+=i*e},this.update=function(t,e){if(this.rotate){let s=2;this.spinWeapons.forEach((i,h)=>{if(i.attack){let n=2*e*Math.PI/s+2*Math.PI/this.numberOfRotatingItems*h;i.x=this.hero.e.x+32+this.distanceFromHero*Math.cos(n),i.y=this.hero.e.y+32+this.distanceFromHero*Math.sin(n),i.update(t)}})}if(this.chaseWeapons.forEach(e=>{e.attack&&this.applySeparation(e,t)}),this.chaseWeapons.forEach(e=>{if(e.attack&&this.chase){switch(e.chasePhase){case"search":this.targetEnemy=null;let t=1/0;Lt.spawner.enemies.forEach(s=>{if(!this.chasingTargets.has(s)&&s.active){let i=e.x-s.e.x,h=e.y-s.e.y,n=Math.sqrt(i*i+h*h);n<t&&n<200&&(t=n,this.targetEnemy=s)}}),this.targetEnemy?(this.chasingTargets.add(this.targetEnemy),e.chasePhase="attack"):e.chasePhase="return";break;case"attack":if(this.targetEnemy&&this.targetEnemy.active){let t=this.targetEnemy.e.x-e.x,s=this.targetEnemy.e.y-e.y,i=Math.atan2(s,t);e.x+=5*Math.cos(i),e.y+=5*Math.sin(i),Math.sqrt(t*t+s*s)<5&&(e.chasePhase="return")}else e.chasePhase="return";break;case"return":this.targetEnemy&&this.chasingTargets.delete(this.targetEnemy);let s=60,i=this.chaseWeapons.length,h=this.chaseWeapons.indexOf(e),n=2*Math.PI/i*h,a=this.hero.e.x+30+s*Math.cos(n),o=this.hero.e.y+30+s*Math.sin(n),r=a-e.x,c=o-e.y;if(Math.sqrt(r*r+c*c)>5){let t=Math.atan2(c,r);e.x+=5*Math.cos(t),e.y+=5*Math.sin(t)}else e.chasePhase="search"}e.update(t),Lt.shadow.x=e.x,Lt.shadow.y=e.y+60,Lt.shadow.update(t)}}),this.loop&&this.figureEightEntity.attack){radius=120;let s=2,i=this.hero.e.x+32+radius*Math.sin(e*s),h=this.hero.e.y+50+radius*Math.sin(2*e*s);this.figureEightEntity.x=i,this.figureEightEntity.y=h,this.figureEightEntity.update(t)}}}function ct(){this.arrow=new P(11,12,100,60,0,O.ARROW);let t=0,e=0;this.update=function(s){let i=$(.05);Vt.clear(),ctx.save(),J(ctx,.8,"black",0,0,ft,dt);var h=["#a8f2cb","#88e4b0"];h=1==qt?["#a8f2cb","#88e4b0"]:["#ffb3a6","#ff9e9a"];const n=Math.ceil(Math.sqrt(ctx.canvas.width**2+ctx.canvas.height**2)/50);for(let t=-n;t<n+10;t++)ctx.fillStyle=h[t%2],ctx.beginPath(),ctx.moveTo(50*t+e,0),ctx.lineTo(50*(t+1)+e,0),ctx.lineTo(50*(t+1)+e-ctx.canvas.height,ctx.canvas.height),ctx.lineTo(50*t+e-ctx.canvas.height,ctx.canvas.height),ctx.closePath(),ctx.fill();(e-=.5)<=-100&&(e=0);let a=`${i}px Arial`;if(V(ctx,1,a,"Black","GameDevJS 2024",30,.1*dt,12),j(ctx,1,a,"WHITE","GameDevJS 2024 ",30,.1*dt),a=`${i-15}px Arial`,t<=0&&(oe()?(t=.3,xt--):re()&&(t=.3,xt++),ye()&&(qt=(qt+1)%2,t=.3)),xt=(xt+3)%3,nt(0,0,300,300,15,qt),0==xt){if(this.arrow.y=100,V(ctx,1,a,"BLACK","Select Hair (Left / Right)",30,.2*dt,6),j(ctx,1,a,"WHITE","Select Hair (Left / Right)",30,.2*dt),(ne()||ae())&&t<=0){t=.3;const e=[O.HAIR1,O.HAIR2,O.HAIR3,O.HAIR4];Lt.hero.hair.type=e[(e.indexOf(Lt.hero.hair.type)+1)%e.length],Lt.hero.change=!0}}else if(1==xt){if(this.arrow.y=140,V(ctx,1,a,"BLACK","Select Head (Left / Right)",30,.2*dt,6),j(ctx,1,a,"WHITE","Select Head (Left / Right)",30,.2*dt),(ne()||ae())&&t<=0){t=.3;const e=[O.HEAD1,O.HEAD2,O.HEAD3];Lt.hero.head.type=e[(e.indexOf(Lt.hero.head.type)+1)%e.length],Lt.hero.change=!0,Lt.hero.head.type==O.HEAD3||Lt.hero.head.type==O.HEAD2?(Lt.hero.rHand.sx=16,Lt.hero.rHand.sy=28,Lt.hero.lHand.sx=16,Lt.hero.lHand.sy=28):(Lt.hero.rHand.sx=30,Lt.hero.rHand.sy=9,Lt.hero.lHand.sx=30,Lt.hero.lHand.sy=9)}}else 2==xt&&(this.arrow.y=170,V(ctx,1,a,"BLACK","Select Clothes (Left / Right)",30,.2*dt,6),j(ctx,1,a,"WHITE","Select Clothes (Left / Right)",30,.2*dt));t-=s,Lt.hero.e.x=65,Lt.hero.e.y=30,ctx.save(),ctx.scale(3,3),Lt.hero.update(s),ctx.restore(),ctx.save(),ctx.scale(1.5,1.5),this.arrow.update(s),ctx.restore();let o=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0);Q(ctx,"Space to Start",a,ft/2,o-30),ce()&&(ut=!0)}}function lt(){this.cam=new u,this.tips=!0,this.time=0,this.reset=!1,this.hero=new D(16,16,0,0,0,O.HERO),this.heroShadow=new P(11,4,0,0,0,O.SHADOW,1),this.shadow=new P(7,3,0,0,0,O.SHADOW,1),this.attacks=new rt(this.hero),this.spawner=new f(this.hero.e),this.decor=new l,this.intro=new ct;let t=3,e=20,s=0;this.shake=0,this.shakeTime=0,this.shop=!1,this.chests=[],this.chests.push(new P(16,13,-70,30,0,O.CHEST,1)),this.chests.push(new P(16,13,65,30,0,O.CHEST,2)),this.chests.push(new P(16,13,200,30,0,O.CHEST,3));let i=new P(6,5,-30,10,0,O.ONE),h=new P(7,5,100,10,0,O.TWO),n=new P(7,5,230,10,0,O.THREE);this.upz=["hat","figure8","chaser","shield","shieldSpeed"],this.update=function(a,r=!1){var c=ctx.createLinearGradient(0,0,0,ctx.canvas.height);if(c.addColorStop(0,"#3CB371"),c.addColorStop(1,"#A6F1C8"),r){if(this.shake=Qt?G(-2,2):0,this.shakeTime>0&&(this.shakeTime-=a),this.cam.x=q(350-this.hero.e.x,this.cam.x,.1),this.cam.y=q(200-this.hero.e.y,this.cam.y,.1),wt+=a,Vt.clear(),ctx.fillStyle=c,ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height),this.time+=a,this.shop){wt=0,this.chests.forEach(t=>{switch(t.update(a),t.content){case"chaser":if(Lt.attacks.chaseWeapons.filter(t=>!0===t.attack).length<4){var e=Lt.attacks.chaseWeapons[Lt.attacks.chaseWeapons.filter(t=>!0===t.attack).length];e.x=t.x,e.y=t.y-32,e.update(a)}break;case"shield":(s=Lt.attacks.spinWeapons[0]).x=t.x,s.y=t.y-32,s.update(a);break;case"figure8":var s;(s=Lt.attacks.figureEightEntity).x=t.x,s.y=t.y-32,s.update(a);break;case"hat":var i=this.hero.hat;i.x=t.x-50,i.y=t.y-60,i.update(a)}if(t.isCollidingWith(this.hero.e)&&!t.open)if(t.open=!0,1==t.id&&this.hero.power>=10){this.hero.power-=10,t.sx=50,this.hero.hp=this.hero.maxHP;for(let e=0;e<30;e++)Lt.hero.particles.push(new o(G(3,15),G(3,15),t.x+50,t.y+60,0,"circle",!0,y))}else if(2==t.id&&this.hero.power>=20){this.hero.power-=20,t.sx=50,this.applyUpgrade(t.content);for(let e=0;e<30;e++)Lt.hero.particles.push(new o(G(3,15),G(3,15),t.x+50,t.y+60,0,"circle",!0,y))}else if(3==t.id&&this.hero.power>=30){this.hero.power-=30,t.sx=50,this.applyUpgrade(t.content);for(let e=0;e<30;e++)Lt.hero.particles.push(new o(G(3,15),G(3,15),t.x+50,t.y+60,0,"circle",!0,y))}}),i.update(a),h.update(a),n.update(a),ce()&&(this.spawner.addEnemy(30,300),0,t=3,this.shop=!1,this.chests.forEach(t=>{t.open=!1,t.sx=67}));let e=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),s=`${$(.05)}px Arial`;Q(ctx,"Space for next wave",s,ft/2,e-60)}this.shop||this.decor.update(a),this.hero.update(a),this.hero.e.flip?this.heroShadow.x=this.hero.e.x+4:this.heroShadow.x=this.hero.e.x+18,this.heroShadow.y=this.hero.e.y+74,this.heroShadow.update(a),t<=0&&wt<=5&&!this.shop?(this.spawner.update(a,this.time),this.attacks.update(a,this.time),B(ctx,wt,5)):wt>=5?(this.shop=!0,this.randomChests(),wt=0,this.spawner.enemies=[],this.hero.e.x=65,this.hero.e.y=140):t>0&&(t-=a,Math.ceil(t)!=s&&(e=20),st(330,80,Math.ceil(t),e),e+=.3,s=Math.ceil(t)),F(ctx,this.hero.hp,100,"#f68687","#a15156","#faf1f0",0),F(ctx,this.hero.power,100,"#84e3b3","#589572","#f0faf7",30),ht(this.spawner.enemies.length),it(Bt)}else this.intro.update(a)},this.applyUpgrade=function(t){switch(t){case"chaser":let e=Lt.attacks.chaseWeapons.filter(t=>!0===t.attack).length;e<4&&(this.attacks.chaseWeapons[e].attack=!0),3==e&&this.removeItem("chaser");break;case"shield":let s=Lt.attacks.spinWeapons.filter(t=>!0===t.attack).length;s<5&&(this.attacks.spinWeapons[s].attack=!0),4==s&&this.removeItem("shield");break;case"figure8":this.attacks.figureEightEntity.attack=!0,this.removeItem("figure8");break;case"hat":this.removeItem("hat")}},this.randomChests=function(){for(let t=this.upz.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[this.upz[t],this.upz[e]]=[this.upz[e],this.upz[t]]}this.chests[0].content="HP",this.chests[1].content=this.upz[0],this.chests[2].content=this.upz[1]},this.removeItem=function(t){const e=this.upz.indexOf(t);e>-1&&this.upz.splice(e,1)}}let ft=window.innerWidth,dt=window.innerHeight,ut=!1,xt=0,yt=0,pt=Date.now(),mt=Date.now(),wt=0,gt=new N(0,0),kt=new N(0,0),Et=new U(0,0,0,0),vt=!1,Mt=!1,Ht=!1,bt=!1,It=0,St=new Image;St.src="atlas.png";let At=new Image,Lt=new lt,Rt=!1,Ct=!1,Tt=!1,Wt=!1,Pt=!1,Dt=.1,Ot=4,Bt=60,Ft=0,Ut=0;var Gt=800,Yt=600,zt=window.innerWidth,Nt=window.innerHeight,Kt=Math.max(zt/Gt,Nt/Yt),qt=1,Xt=!1,$t=!1,Jt=!1,jt=!1;let Qt=!0;function startGame(){Vt.start(),me(this.ctx),Zt(),document.getElementById("gameControls").addEventListener("touchstart",t=>{t.preventDefault()},{passive:!1})}a();let Vt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=Gt*Kt,this.canvas.height=Yt*Kt,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),this.context.setTransform(Kt,0,0,Kt,0,0),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameId=requestAnimationFrame(ie),window.addEventListener("keydown",function(e){Ct||(Ct=!0,t.loop=!0,t.play()),Dt<=0&&3==xt&&(Rt=!0),e.preventDefault(),Vt.keys=Vt.keys||[],Vt.keys[e.keyCode]="keydown"==e.type}),window.addEventListener("keyup",function(t){Vt.keys[t.keyCode]="keydown"==t.type,t.keyCode==T&&(Ht=!0),t.keyCode==M&&(Tt=!Tt),t.keyCode==W&&(Lt.tips=!Lt.tips)}),window.addEventListener("mouseup",function(t){t.preventDefault(),pe(),vt=!0,0===t.button?Wt=!1:2===t.button&&(Pt=!1)}),window.addEventListener("mousedown",function(t){t.preventDefault(),0===t.button?Wt=!0:2===t.button&&(Pt=!0)}),window.addEventListener("resize",me),window.addEventListener("mousemove",function(t){t.preventDefault();var e=Vt.canvas.getBoundingClientRect();gt.set((t.clientX-e.left)/(e.right-e.left)*ft,(t.clientY-e.top)/(e.bottom-e.top)*dt)}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){Vt.frameId&&(cancelAnimationFrame(Vt.frameId),Vt.frameId=null)},clear:function(){this.context.clearRect(0,0,4*this.canvas.width,4*this.canvas.height)}};function Zt(){document.getElementById("up").addEventListener("touchstart",()=>_t("up")),document.getElementById("up").addEventListener("touchend",()=>te("up")),document.getElementById("down").addEventListener("touchstart",()=>_t("down")),document.getElementById("down").addEventListener("touchend",()=>te("down")),document.getElementById("left").addEventListener("touchstart",()=>_t("left")),document.getElementById("left").addEventListener("touchend",()=>te("left")),document.getElementById("right").addEventListener("touchstart",()=>_t("right")),document.getElementById("right").addEventListener("touchend",()=>te("right")),document.getElementById("aButton").addEventListener("touchstart",()=>ee("A")),document.getElementById("bButton").addEventListener("touchstart",()=>ee("B"))}function _t(t){console.log("Move:",t),"up"==t?Xt=!0:"down"==t?$t=!0:"left"==t?jt=!0:"right"==t&&(Jt=!0),console.log(t+" - "+Xt)}function te(t){"up"==t?Xt=!1:"down"==t?$t=!1:"left"==t?jt=!1:"right"==t&&(Jt=!1),console.log(t+" - "+Xt)}function ee(t){ut||(ut=!0)}let se=null;function ie(t){se||(se=t);let e=(t-se)/1e3;se=t,Ft++,(Ut+=e)>=1&&(Bt=Ft/Ut,Ft=0,Ut=0),he(e),it(Bt),Vt.frameId=requestAnimationFrame(ie)}function he(t){Mt&&(wt=0,Mt=!1,bt=!1,It=0,Rt=!1,ut=!1,Dt=3),Rt&&(ut=!0),Dt>0&&(Dt-=t),Lt.update(t,ut),vt=!1}function ne(){return Vt.keys&&(Vt.keys[x]||Vt.keys[k])||jt}function ae(){return Vt.keys&&(Vt.keys[y]||Vt.keys[v])||Jt}function oe(){return Vt.keys&&(Vt.keys[p]||Vt.keys[g])||Xt}function re(){return Vt.keys&&(Vt.keys[m]||Vt.keys[E])||$t}function ce(){return Vt.keys&&Vt.keys[I]||Wt}function le(){return Vt.keys&&Vt.keys[w]||Pt}function fe(){return Vt.keys&&Vt.keys[A]}function de(){return Vt.keys&&Vt.keys[L]}function ue(){return Vt.keys&&Vt.keys[R]}function xe(){return Vt.keys&&Vt.keys[C]}function ye(){return Vt.keys&&Vt.keys[W]}function pe(){kt.set(gt.x,gt.y),Et.x=gt.x-5,Et.y=gt.y+5,Et.h=10,Et.w=10,console.log(kt)}function me(){zt=window.innerWidth,Nt=window.innerHeight,ft=window.innerWidth,dt=window.innerHeight,Kt=Math.max(zt/Gt,Nt/Yt),scaleFitNative=Math.min(zt/Gt,Nt/Yt),ctx.canvas.width=Gt*Kt,ctx.canvas.height=Yt*Kt,this.context=ctx.canvas.getContext("2d"),this.context.setTransform(Kt,0,0,Kt,0,0),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1}